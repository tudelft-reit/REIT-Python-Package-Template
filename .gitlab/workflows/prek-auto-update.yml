# Update the versions in of the precommit hooks in the .pre-commit-config.yaml
# files, both for this repo and for the template project.
pre_commit_update:
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    - uv venv
    - uv pip install prek Jinja2
    - git config --global user.email "gitlab-ci@example.com"
    - git config --global user.name "GitLab CI"
    - git branch --delete --force prek-update || echo "No branch to delete"
  script:
    - git switch --create prek-update
    - uv run prek auto-update
    - cd project_template
    - uv run ../render-precommit.py
    - uv run prek auto-update
    - uv run ../update-versions-in-template.py
    - rm .pre-commit-config.yaml
    - cd ..
    - git add -u
    # This line needs to be folded (>) to avoid a YAML syntax error
    - >
      git commit -m "chore: update prek hooks" || echo "No changes to commit"
    - >-
      git push
      "https://${GITLAB_USER_LOGIN}:${CI_GIT_TOKEN}@gitlab.ewi.tudelft.nl/reit/python-package-template.git"
      HEAD:prek-update
      --push-option="merge_request.create"
      --push-option="merge_request.target=main"
