# Check that creating a new project using the template works.
# This includes running pre-commit and pytest on the created project.
test_project_generation:
  stage: test
  parallel:
    # Test for all combinations of type checking and environment managers
    matrix:
      - ENV_MANAGER: uv
        TYPING: [no_typing, loose, strict]
      - ENV_MANAGER: pixi
        TYPING: [no_typing, loose, strict]
  before_script:
    - uv venv
    - uv tool install copier --with jinja2-shell-extension
  script:
      - export PATH="/root/.local/bin:$PATH"
      - git config --global user.name "Python Template"
      - git config --global user.email "pyton-template@tudelft.nl"
      - >
        if [ "$ENV_MANAGER" == "pixi" ]; then
          curl -fsSL https://pixi.sh/install.sh | bash
          export PATH="/root/.pixi/bin:$PATH"
        fi
      - >
          copier copy
          --defaults
          --trust
          --vcs-ref HEAD
          -d project_name=python-template-uv-example
          -d typing=$TYPING
          -d environment_manager=$ENV_MANAGER
          . python-template-uv-example
      - cd python-template-uv-example
      - if [ "$ENV_MANAGER" == "uv" ]; then uv run pytest; fi
      - if [ "$ENV_MANAGER" == "pixi" ]; then pixi run -e dev pytest; fi

# Run pre-commit checks for the project template itself.
test_pre_commit:
  stage: test
  before_script:
    - uv venv
    - uv pip install pre-commit
  script:
    - uv run pre-commit run --all
