# Check that creating a new project using the template works.
# This includes running prek and pytest on the created project.
test_project_generation:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
  parallel:
    # Test for uv and pixi with with both hosts and two python versions
    matrix:
      - ENV_MANAGER: uv
        HOST: [gitlab.ewi.tudelft.nl, github.com]
        PYTHON_VERSION: "3.10"
      - ENV_MANAGER: pixi
        HOST: [gitlab.ewi.tudelft.nl, github.com]
        PYTHON_VERSION: "3.10"
      - ENV_MANAGER: uv
        HOST: gitlab.ewi.tudelft.nl
        PYTHON_VERSION: "3.13"
  before_script:
    - uv venv
    - uv tool install copier --with jinja2-shell-extension --with copier-templates-extensions
  script:
      - export PATH="/root/.local/bin:$PATH"
      - git config --global user.name "Python Template"
      - git config --global user.email "pyton-template@tudelft.nl"
      - >
        if [ "$ENV_MANAGER" == "pixi" ]; then
          curl -fsSL https://pixi.sh/install.sh | bash
          export PATH="/root/.pixi/bin:$PATH"
        fi
      - >
          copier copy
          --defaults
          --trust
          --vcs-ref HEAD
          -d project_name=python-template-uv-example
          -d environment_manager=$ENV_MANAGER
          -d host=$HOST
          -d min_python_version=$PYTHON_VERSION
          . python-template-uv-example
      - cd python-template-uv-example

      - if [ "$ENV_MANAGER" == "uv" ]; then uv run pytest; fi
      - if [ "$ENV_MANAGER" == "uv" ]; then uv run mkdocs build; fi

      - if [ "$ENV_MANAGER" == "pixi" ]; then pixi run -e dev pytest; fi
      - if [ "$ENV_MANAGER" == "pixi" ]; then pixi run -e dev mkdocs build; fi

# Run prek checks for the project template itself.
test_pre_commit:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
  stage: test
  before_script:
    - uv venv
    - uv pip install prek
  script:
    - uv run prek run --all-files
