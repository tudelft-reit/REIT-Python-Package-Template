# Check that creating a new project using the template works.
# This includes running pre-commit and pytest on the created project.
test_project_generation:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
  parallel:
    # Test for all combinations of type checking and environment managers
    matrix:
      - ENV_MANAGER: uv
        HOST: [gitlab.ewi.tudelft.nl, github.com]
      - ENV_MANAGER: pixi
        HOST: [gitlab.ewi.tudelft.nl, github.com]
  before_script:
    - uv venv
    - uv tool install copier --with jinja2-shell-extension --with copier-templates-extensions
  script:
      - export PATH="/root/.local/bin:$PATH"
      - git config --global user.name "Python Template"
      - git config --global user.email "pyton-template@tudelft.nl"
      - >
        if [ "$ENV_MANAGER" == "pixi" ]; then
          curl -fsSL https://pixi.sh/install.sh | bash
          export PATH="/root/.pixi/bin:$PATH"
        fi
      - >
          copier copy
          --defaults
          --trust
          --vcs-ref HEAD
          -d project_name=python-template-uv-example
          -d environment_manager=$ENV_MANAGER
          -d host=$HOST
          . python-template-uv-example
      - cd python-template-uv-example
      - if [ "$ENV_MANAGER" == "uv" ]; then uv run pytest; fi
      - if [ "$ENV_MANAGER" == "pixi" ]; then pixi run -e dev pytest; fi

# Run pre-commit checks for the project template itself.
test_pre_commit:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
  stage: test
  before_script:
    - uv venv
    - uv pip install pre-commit
  script:
    - uv run pre-commit run --all
