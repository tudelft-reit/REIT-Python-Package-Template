# CONFIGURATION -------------------------
_subdirectory: project_template

_skip_if_exists:
  - CHANGELOG.md

_jinja_extensions:
  - jinja2_shell_extension.ShellExtension
  - copier_templates_extensions.TemplateExtensionLoader
  - extensions/context.py:ContextUpdater

# PROMPT --------------------------------
project_name:
  type: str
  help: Please provide the name of your project.
  validator: >-
    {% if not project_name %}
      You must provide a name for the project.
    {% elif ' ' in project_name %}
      You must provide a project name without spaces.
    {% endif %}

host:
  type: str
  help: Where would you like to host your code?
  default: github.com
  choices:
    github.com: github.com
    gitlab.ewi.tudelft.nl: gitlab.ewi.tudelft.nl
    gitlab.tudelft.nl [Discouraged]: gitlab.tudelft.nl

org:
  type: str
  help: What {{host}} user is this project under? For gitlab, this is your netid or group.
  # Get the username of this computer, by expanding the system variables, _copier_conf
  # is not available. So we manually check if the variable was expanded.
  default: >-
    {%- if "$USER" | expandvars != "$USER" -%}
      {{ "$USER" | expandvars }}
    {%- else -%}
      {{ "$UserName" | expandvars }}
    {%- endif -%}
  validator: >-
    {% if not org %} You must provide a org for the project. It might just be
    your user name on the site (like GitHub) you are targeting. {% endif %}

url:
  type: str
  help: Provide/modify the url to the {{host}} repository if needed.
  default: https://{{host}}/{{org}}/{{project_name}}

python_name:
  type: str
  help: The Python package import name (for `import NAME` in Python code)
  default: "{{ project_name|lower|replace('-', '_')|replace(' ', '_') }}"
  when: false  # Hide this question, we just have it to be able to compute the value

full_name:
  type: str
  help: Who's the main person responsible for this code?
  default: "{{ 'git config user.name' | shell() | trim }}"
  validator: >-
    {% if not full_name %} You must provide a name (possibly yours) to place in
    your config files. {% endif %}

email:
  type: str
  help: What's their email?
  default: "{{ 'git config user.email' | shell() | trim }}"
  validator: >-
    {% if not (email | regex_search('^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$'))
    %}
    You must provide a valid email to place in
    your config files.
    {% endif %}

project_short_description:
  type: str
  help: Write a short description of your project.
  default: A great package.

license:
  type: str
  help: Select a license
  default: GPL
  choices:
    - GPL
    - BSD
    - Apache
    - MIT
    - No license (others may not use, share or modify the code)

min_python_version:
  type: str
  help: What is the minimum version of Python your project will support?
  default: '3.10'
  validator: >-
    {% if not (min_python_version | regex_search('[3][.][0-9]+')) %}
    Please supply a valid Python 3 version (e.g. 3.11).
    {% endif %}

environment_manager:
  type: str
  help: Select which virtual environment manager to use. Choose uv unless you need conda dependencies.
  default: uv
  choices:
    uv   (pip dependencies only) [Recommended]: uv
    pixi (conda and pip dependencies): pixi

_message_after_copy: |
  Your project "{{ project_name }}" has been successfully created in {{ _copier_conf.dst_path }} folder!

      ###################################################
      ---------------------------------------------------
      DO THE FOLLOWING MANUAL STEPS TO FINISH UP THE SETUP
      ---------------------------------------------------
      ###################################################

          {% if _copier_conf.os not in ['linux', 'macos'] and environment_manager=='pixi' -%}
          - Enable running on DAIC/DelftBlue and fix the CI
            Add "linux-64" to the list of platforms in [tool.pixi.project] in the pyproject.toml
            Commit and push
          {%- endif %}

          {%- if host=='gitlab.tudelft.nl' %}
          - Setup a CI runner for your project. See the link below for a tutorial
            https://tu-delft-dcc.github.io/docs/software/automation/gitlab/gitlab_docker.html

          {% endif %}

          {%- if is_new_project -%}
          - [Optional step] Set the remote to use ssh instead of https

              git remote set-url origin git@{{ url | replace("https://", "") | replace("/" ~ org, ":" ~ org ) }}.git

          - Push the commit to a new repo on {{host}}
              {%- if host=='github.com' -%}
              . Go to https://github.com/new
              and create a new repository named `{{ project_name }}` as an empty repository.
              Then push your commits with:
              {%- endif %}

              git push --set-upstream origin main
          {%- else -%}
          - Have a look at the diff of each file that was modified and add back any changes that you want to keep.
          {%- endif %}

          - Have a look at the repository README.md file for additional information

_tasks:
  - command: git init --initial-branch main
    when: '{{ is_new_project }}'

    ###
    # uv environment management
    ###
  - command: uv sync
    when: "{{ environment_manager=='uv' }}"
  - command: uv run pre-commit install
    when: "{{ environment_manager=='uv' }}"

    ###
    # pixi environment management
    ##
  - command: pixi init --format pyproject
    when: "{{ environment_manager=='pixi' }}"
  - command: pixi install --all
    when: "{{ environment_manager=='pixi' }}"
  - command: pixi run --environment dev pre-commit install
    when: "{{ environment_manager=='pixi' }}"

    ###
    # Git repo setup
    ###
  - command: git remote add origin {{ url }}.git
    when: '{{ is_new_project }}'

  - command: git add --all
    when: '{{ is_new_project }}'

  - command: git commit --message "REIT python template setup"
    when: '{{ is_new_project }}'

  - command: git tag v0.0.1
    when: '{{ is_new_project }}'
